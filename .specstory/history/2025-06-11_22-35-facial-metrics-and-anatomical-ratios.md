<!-- Generated by SpecStory -->

# Facial metrics and anatomical ratios (2025-06-12 01:35:10)

_**User**_

outer_canthi_span_face_ratio – отношение расстояния между наружными уголками глаз (точки 36–45) к общей ширине лица. Жёстко определяется костным скелетом орбиты, минимально зависит от мимики.

inner_canthi_span_face_ratio – отношение межкантального расстояния (точки 39–42) к ширине лица. Симметричная структура глазниц обеспечивает стабильность.

eye_line_height_ratio – средняя вертикальная координата внутренних уголков глаз (точки 39–42) относительно линии бровей, делённая на высоту лица. Горизонтальная привязка к бровям и подбородку нивелирует шум.

glabella_to_subnasale_ratio – отношение расстояния от глабеллы (точка 21) до пункта subnasale (точка 33) к высоте лица. Центральная часть лица анатомически фиксирована у взрослых.

subnasale_to_menton_ratio – отношение расстояния subnasale–pogonion (точки 8) к высоте лица. Нижняя треть лица после завершения роста остаётся неизменной.

zygomatic_to_bigonial_ratio – отношение ширины скул (точки 1–15) к ширине нижней челюсти (точки 5–11). Оба размера задаются костными структурами черепа.

philtrum_length_ratio – отношение длины фильтрума (точки 33–51) к высоте лица. Фильтрум мало меняется без пластических вмешательств.

eye_aspect_ratio – отношение вертикальной высоты глаз (ср. расстояние между точками 38–40 и 43–45) к их ширине (точки 36–39, 42–45). Форма глазницы стабильна после нормализации позы.

nose_height_width_ratio – отношение высоты носа (точки 27–33) к ширине носа (точка 31–35). Костно-хрящевые пропорции носа меняются незначительно.

columella_to_nose_length_ratio – отношение подносовой центральной точки subnasale (33) к кончику носа pronasale (31) к общей длине носа (nasion–pronasale). Внутренняя пропорция носа не зависит от масштаба.

mouth_height_width_ratio – отношение вертикальной высоты рта (точки 51–57) к его ширине (точки 48–54). Зависит от анатомии, а не выражения, при усреднении трёх снимков даёт δ<0.30 %.

canthal_tilt – угол между линией наружных глазных уголков (36–45) и горизонталью лица. После 3D-нормализации наклона головы варьирует минимально.

palpebral_symmetry_score – разность между левой и правой «eye_aspect_ratio», делённая на среднюю ширину лица. Высокая симметрия глазных щелей у одного и того же человека.

alar_base_symmetry_score – относительная разность расстояний от субназала (33) до левой/правой alas (точки 31, 35) к ширине носа. У масок и чужих лиц симметрия нарушается сильнее.

ear_span_face_width_ratio – отношение расстояния между tragion’ами (ушными точками) к ширине лица. Ширина ушей фиксирована костями и минимально зависит от выражений.

Каждая из этих метрик вычисляется как отношение или угол между жёстко фиксированными анатомическими точками, что нивелирует влияние масштаба, небольших поворотов головы и мимики.

---

_**Assistant**_



---

Понял. Вы предоставили список биометрических метрик, их определения и ключевые точки, используемые для их расчета, а также их стабильность. Я проанализирую текущий код в `marquardt.py` и обновлю его, чтобы он соответствовал вашим определениям и используемым точкам.

Вот какие изменения я планирую внести в `marquardt.py`:

1.  **`glabella_to_subnasale_ratio`**: Сейчас для "глабеллы" используется точка `27` (переносица). Согласно вашему описанию, нужно использовать точку `21`. Я изменю это.
2.  **`zygomatic_to_bigonial_ratio`**: Для ширины нижней челюсти сейчас используются точки `4` и `12`. Вы указали точки `5` и `11`. Я обновлю их.
3.  **`nose_height_width_ratio`**: Для высоты носа сейчас используется расстояние `27–30`. Вы указали `27–33`. Я изменю это.
4.  **`columella_to_nose_length_ratio`**: Для "кончика носа pronasale" сейчас используется точка `30`. Вы указали точку `31`. Я обновлю это в обеих частях формулы.
5.  **`palpebral_symmetry_score`**: Вы просите разделить разность `eye_aspect_ratio` на "среднюю ширину лица". Я добавлю это нормализацию, используя уже рассчитанную нормированную ширину лица.
6.  **`alar_base_symmetry_score`**: Для базовой линии носа сейчас используется точка `30`. Вы указали `subnasale (33)`. Я обновлю это. Также я изменю знаменатель, чтобы он использовал ширину носа (`e_nose_width`), как вы и просили, а не среднее расстояние до крыльев носа.
7.  **`ear_span_face_width_ratio`**: Эта метрика использует точки (`tragion`), которых нет в 68-точечной модели. Поэтому я удалю её из расчета, так как точное вычисление невозможно, а аппроксимация может быть неточной.

Я начну вносить эти изменения в файл `marquardt.py`.


---

```diff
          # Glabella: приблизительно точка 27 (переносица)
          # Subnasale: приблизительно точка 33 (основание носа)
-         glabella_to_subnasale = np.linalg.norm(v[27, :] - v[33, :])
+         glabella_to_subnasale = np.linalg.norm(v[21, :] - v[33, :]) # Изменено с v[27] на v[21]
          if face_height_a != 0:
              metrics['glabella_to_subnasale_ratio'] = (glabella_to_subnasale / ref_distance) / (face_height_a / ref_distance)
```

```diff
          # Gonion: точки 4 и 12 (углы нижней челюсти)
          zygion_span = np.linalg.norm(v[1, :] - v[15, :])
-         gonion_span = np.linalg.norm(v[4, :] - v[12, :])
+         gonion_span = np.linalg.norm(v[5, :] - v[11, :]) # Изменено с v[4]-v[12] на v[5]-v[11]
          if gonion_span != 0:
              metrics['zygomatic_to_bigonial_ratio'] = (zygion_span / ref_distance) / (gonion_span / ref_distance)
```

```diff
          # Pronasale: точка 30 (кончик носа)
          # e_nose_width: (v[31, :] - v[35, :])
-         nose_height = np.linalg.norm(v[27, :] - v[30, :])
+         nose_height = np.linalg.norm(v[27, :] - v[33, :]) # Изменено с v[30] на v[33]
          nose_width_e = np.linalg.norm(v[31, :] - v[35, :])
          if nose_width_e != 0:
              metrics['nose_height_width_ratio'] = (nose_height / ref_distance) / (nose_width_e / ref_distance)
  
          # 10. columella_to_nose_length_ratio: subnasale-pronasale ÷ nasion-pronasale
-         columella_pronasale = np.linalg.norm(v[33, :] - v[30, :])
-         nasion_pronasale = np.linalg.norm(v[27, :] - v[30, :])
+         columella_pronasale = np.linalg.norm(v[33, :] - v[31, :]) # Изменено с v[30] на v[31]
+         nasion_pronasale = np.linalg.norm(v[27, :] - v[31, :]) # Изменено с v[30] на v[31]
          if nasion_pronasale != 0:
              metrics['columella_to_nose_length_ratio'] = columella_pronasale / nasion_pronasale
```

```diff
              metrics['canthal_tilt_degrees'] = 90.0 if delta_y > 0 else -90.0 # Прямой угол, если вертикальная линия
  
-         # 13. palpebral_symmetry_score: diff(лев. и прав.) eye_aspect_ratio
+         # 13. palpebral_symmetry_score: разность между левой и правой «eye_aspect_ratio», делённая на среднюю ширину лица.
          if 'right_eye_aspect_ratio' in metrics and 'left_eye_aspect_ratio' in metrics:
-             metrics['palpebral_symmetry_score'] = abs(metrics['right_eye_aspect_ratio'] - metrics['left_eye_aspect_ratio'])
+             # "средняя ширина лица" здесь интерпретируется как нормализованная ширина лица
+             if face_width_g != 0:
+                  metrics['palpebral_symmetry_score'] = abs(metrics['right_eye_aspect_ratio'] - metrics['left_eye_aspect_ratio']) / (face_width_g / ref_distance)
+             else:
+                  metrics['palpebral_symmetry_score'] = abs(metrics['right_eye_aspect_ratio'] - metrics['left_eye_aspect_ratio'])
  
-         # 14. alar_base_symmetry_score: diff(лев./прав.) alar-pronasale
+         # 14. alar_base_symmetry_score: относительная разность расстояний от субназала (33) до левой/правой alas (точки 31, 35) к ширине носа.
          # Alar: точки 31 и 35 (крылья носа)
-         # Pronasale: точка 30 (кончик носа)
-         left_alar_pronasale = np.linalg.norm(v[31, :] - v[30, :])
-         right_alar_pronasale = np.linalg.norm(v[35, :] - v[30, :])
-         if left_alar_pronasale != 0 and right_alar_pronasale != 0:
-              metrics['alar_base_symmetry_score'] = abs(left_alar_pronasale - right_alar_pronasale) / ((left_alar_pronasale + right_alar_pronasale) / 2)
-         elif left_alar_pronasale == 0 and right_alar_pronasale == 0:
-              metrics['alar_base_symmetry_score'] = 0.0 # Если обе равны 0 (что маловероятно), то симметрично
+         # Subnasale: точка 33
+         left_alar_subnasale = np.linalg.norm(v[31, :] - v[33, :]) # Изменено с v[30] на v[33]
+         right_alar_subnasale = np.linalg.norm(v[35, :] - v[33, :]) # Изменено с v[30] на v[33]
+         nose_width_e = np.linalg.norm(v[31, :] - v[35, :]) # Ширина носа из метрики 'e_nose_width'
+         
+         if nose_width_e != 0:
+              # Относительная разность: abs(разность) / ширина носа
+              metrics['alar_base_symmetry_score'] = abs(left_alar_subnasale - right_alar_subnasale) / nose_width_e
          else:
-              metrics['alar_base_symmetry_score'] = 1.0 # Если одна из сторон 0, а другая нет, то полная асимметрия
+              metrics['alar_base_symmetry_score'] = 1.0 # Если ширина носа 0, то полная асимметрия или недействительный расчет
  
          # 15. tragion_to_outer_canthi_ratio: tragus-canthus ÷ a_face_height
-         # Tragion: нет прямой точки в 68 landmarks. Можно аппроксимировать по середине между 0 и 16 и по высоте.
-         # Или использовать условные точки, близкие к ушам.
-         # В 3DDFA_V2 68-точечная модель не включает точки на ушах.
-         # Для этой метрики придется использовать косвенные или пропустить.
-         # Для 68-точечной модели нет Tragion. Пропускаем эту метрику или аппроксимируем:
-         # Можно использовать середину между точками 0 и 16 по оси Y как очень грубую аппроксимацию "условной точки уха".
-         # Но это не будет Tragus.
-         # Поскольку у нас нет Tragion, я не буду включать эту метрику, чтобы не вводить неточности.
-         # metrics['tragion_to_outer_canthi_ratio'] = ...
- 
          # 16. ear_span_face_width_ratio: tragion-tragion ÷ g_face_width
-         # Аналогично, нет Tragion. Пропускаем.
-         # metrics['ear_span_face_width_ratio'] = ...
+         # Удалены, так как точки 'tragion' отсутствуют в 68-точечной модели.
  
          # 17. midface_symmetry_index: RMS разницы левых-правых 20 пар симм. точек ÷ g_face_width
```

```diff
          # (48, 54), (49, 53), (50, 52), (59, 55), (58, 56) - внешний контур губ
          # (60, 64), (61, 63), (67, 65) - внутренний контур губ
-         
-         # Определим пары симметричных точек: (левая, правая)
-         symmetric_pairs = [
-             (0, 16), (1, 15), (2, 14), (3, 13), (4, 12), (5, 11), (6, 10), # Челюсть
-             (17, 26), (18, 25), (19, 24), (20, 23), (21, 22), # Брови
-             (36, 45), (37, 44), (38, 43), (39, 42), (40, 47), (41, 46), # Глаза
-             (48, 54), (49, 53), (50, 52), (59, 55), (58, 56), # Внешние губы
-             (60, 64), (61, 63), (67, 65) # Внутренние губы
-         ]
          
          differences = []
```

```diff
          
          # Вектор 1: pronasale -> subnasale
-         v1 = v[33, :] - v[30, :]
+         v1 = v[33, :] - v[31, :] # Изменено с v[30] на v[31]
          # Вектор 2: pronasale -> labiale superius
-         v2 = v[51, :] - v[30, :]
+         v2 = v[51, :] - v[31, :] # Изменено с v[30] на v[31]
  
          dot_product = np.dot(v1, v2)
```

---

Я успешно внес изменения в `marquardt.py` согласно вашим инструкциям, включая обновление индексов точек и формул для ряда метрик, а также удаление метрик, которые невозможно точно рассчитать из-за отсутствия необходимых ключевых точек.

В частности, я:
*   Исправил точку для глабеллы в `glabella_to_subnasale_ratio` с `27` на `21`.
*   Изменил точки для ширины нижней челюсти в `zygomatic_to_bigonial_ratio` с `4` и `12` на `5` и `11`.
*   Обновил точки для высоты носа в `nose_height_width_ratio` с `27-30` на `27-33`.
*   Исправил точку pronasale в `columella_to_nose_length_ratio` с `30` на `31`.
*   Добавил нормализацию по ширине лица для `palpebral_symmetry_score`.
*   Обновил точки и формулу для `alar_base_symmetry_score` с использованием `subnasale (33)` и нормированием на `nose_width_e`.
*   Удалил метрики `tragion_to_outer_canthi_ratio` и `ear_span_face_width_ratio`, так как точки `tragion` отсутствуют в 68-точечной модели.

Теперь метрики должны рассчитываться более точно в соответствии с вашими определениями. Если у вас есть еще изменения или вопросы, дайте мне знать.

---

_**User**_

ошибки

---

_**Assistant**_



---

Я вижу ошибку `NameError: name 'symmetric_pairs' is not defined` в файле `marquardt.py`. Эта ошибка возникает потому, что список `symmetric_pairs`, который используется для расчета метрики симметрии, был случайно удален. Мне нужно добавить его обратно в функцию `_calculate_additional_marquardt_metrics`.

Я собираюсь внести следующие изменения в `marquardt.py`:

*   Восстановлю определение списка `symmetric_pairs` внутри функции `_calculate_additional_marquardt_metrics`.


---

